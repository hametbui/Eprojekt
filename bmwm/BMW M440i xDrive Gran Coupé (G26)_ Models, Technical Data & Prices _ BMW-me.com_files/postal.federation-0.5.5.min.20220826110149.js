/*
 * postal.federation - A base plugin for federating instances of postal.js across various boundaries.
  * Author: Jim Cowart (http://ifandelse.com)
  * Version: v0.5.5
  * Url: http://github.com/postaljs/postal.federation
  * License(s): (MIT OR GPL-2.0)
*/
(function(q,p){"object"===typeof exports&&"object"===typeof module?module.exports=p(require("lodash"),require("postal")):"function"===typeof define&&define.amd?define("postal.federation",["lodash","postal"],p):"object"===typeof exports?exports.postalFedx=p(require("lodash"),require("postal")):q.postalFedx=p(q._,q.postal)})(this,function(q,p){return function(d){function e(b){if(a[b])return a[b].exports;var c=a[b]={exports:{},id:b,loaded:!1};d[b].call(c.exports,c,c.exports,e);c.loaded=!0;return c.exports}
var a={};e.m=d;e.c=a;e.p="";return e(0)}([function(d,e,a){function b(f){return f&&f.__esModule?f:{"default":f}}Object.defineProperty(e,"__esModule",{value:!0});var c=a(1),k=b(c);c=a(2);c=b(c);a(3);var l=a(4),g=a(5),n=a(6),m=a(7),f=b(m);a=a(8);a=b(a);var h=c["default"].fedx={FederationClient:a["default"],packingSlips:l.packingSlips,handlers:n.handlers,clients:g.state._clients,transports:g.state._transports,filters:f["default"],addFilter:m.addFilter,removeFilter:m.removeFilter,canSendRemote:function(f,
a){return(0,m.matchesFilter)(f,a,"out")},configure:g.configure,getPackingSlip:l.getPackingSlip,onFederatedMsg:n.onFederatedMsg,sendMessage:function(f){g.state._ready?k["default"].forEach(this.transports,function(a){a.sendMessage(f)}):g.state._outboundQueue.push(arguments)},disconnect:g.disconnect,_getTransports:function(){return k["default"].reduce(this.transports,function(f,a,c){f[c]=!0;return f},{})},signalReady:function(f,a,c){if(g.state._ready){var h=this._getTransports();switch(arguments.length){case 1:"function"===
typeof f?c=f:"string"===typeof f&&(h={},h[f]=this.transports[f],c=g.NO_OP);break;case 2:"string"===typeof f?(h={},h[f]=this.transports[f]):h=f;c=a||g.NO_OP;break;case 3:h={},h[f]=[a]}k["default"].forEach(h,k["default"].bind(function(f,a){f="boolean"===typeof f?[]:f;this.transports[a].signalReady(f,c)},this))}else g.state._signalQueue.push(arguments)}};e["default"]=h;c["default"].addWireTap(function(f,a){h.canSendRemote(a.channel,a.topic)&&h.sendMessage(a)});c["default"].subscribe({channel:c["default"].configuration.SYSTEM_CHANNEL,
topic:"instanceId.changed",callback:function(){for(g.state._ready=!0;g.state._signalQueue.length;)h.signalReady.apply(h,g.state._signalQueue.shift());for(;g.state._outboundQueue.length;)h.send.apply(h,g.state._outboundQueue.shift());for(;g.state._inboundQueue.length;)h.onFederatedMsg.call(h,g.state._inboundQueue.shift())}});void 0!==c["default"].instanceId()&&(g.state._ready=!0);d.exports=e["default"]},function(d,e){d.exports=q},function(d,e){d.exports=p},function(d,e,a){var b=(d=a(2))&&d.__esModule?
d:{"default":d};b["default"].createUUID||(b["default"].createUUID=function(){for(var a=[],b=0;36>b;b++)a[b]="0123456789abcdef".substr(Math.floor(16*Math.random()),1);a[14]="4";a[19]="0123456789abcdef".substr(a[19]&3|8,1);a[8]=a[13]=a[18]=a[23]="-";return a.join("")});b["default"].instanceId||(b["default"].instanceId=function(){var a=void 0,e=void 0;return function(c){c&&(e=a,a=c,b["default"].publish({channel:b["default"].configuration.SYSTEM_CHANNEL,topic:"instanceId.changed",data:{oldId:e,newId:a}}));
return a}}())},function(d,e,a){Object.defineProperty(e,"__esModule",{value:!0});e.getPackingSlip=function(a){if(Object.prototype.hasOwnProperty.call(c,a))return c[a].apply(this,Array.prototype.slice.call(arguments,1))};var b=(d=a(2))&&d.__esModule?d:{"default":d},c={ping:function(){return{type:"federation.ping",instanceId:b["default"].instanceId(),timeStamp:new Date,ticket:b["default"].createUUID()}},pong:function(a){return{type:"federation.pong",instanceId:b["default"].instanceId(),timeStamp:new Date,
pingData:{instanceId:a.instanceId,timeStamp:a.timeStamp,ticket:a.ticket}}},message:function(a){return{type:"federation.message",instanceId:b["default"].instanceId(),timeStamp:new Date,envelope:a}},disconnect:function(){return{type:"federation.disconnect",instanceId:b["default"].instanceId(),timeStamp:new Date}},bundle:function(a){return{type:"federation.bundle",instanceId:b["default"].instanceId(),timeStamp:new Date,packingSlips:a}}};e.packingSlips=c},function(d,e,a){Object.defineProperty(e,"__esModule",
{value:!0});e.configure=function(a){if(a&&a.filterMode&&"blacklist"!==a.filterMode&&"whitelist"!==a.filterMode)throw Error("postal.fedx filterMode must be 'blacklist' or 'whitelist'.");a&&(k._config=b["default"].defaults(a,c));return k._config};e.disconnect=function(a){a=a||{};var g=k._transports;a.transport&&(g={},g[a.transport]=k._transports[a.transport]);b["default"].forEach(g,function(g){g.disconnect({target:a.target,instanceId:a.instanceId,doNotNotify:!!a.doNotNotify})})};var b=(d=a(1))&&d.__esModule?
d:{"default":d},c={enabled:!0,filterMode:"whitelist",filterDirection:"both"};e.NO_OP=function(){};var k={_clients:[],_transports:{},_ready:!1,_inboundQueue:[],_outboundQueue:[],_signalQueue:[],_config:c};e.state=k},function(d,e,a){function b(a){if(k.state._ready)if(Object.prototype.hasOwnProperty.call(m,a.packingSlip.type))m[a.packingSlip.type](a);else throw Error("postal.federation does not have a message handler for '"+a.packingSlip.type+"'.");else k.state._inboundQueue.push(a)}Object.defineProperty(e,
"__esModule",{value:!0});e.onFederatedMsg=b;var c=a(4),k=a(5),l=a(7),g=(d=a(2))&&d.__esModule?d:{"default":d},n=(a=a(1))&&a.__esModule?a:{"default":a},m={"federation.ping":function(a){a.source.setInstanceId(a.packingSlip.instanceId);a.source.handshakeComplete?a.source.sendPong(a.packingSlip):a.source.sendBundle([(0,c.getPackingSlip)("pong",a.packingSlip),(0,c.getPackingSlip)("ping")])},"federation.pong":function(a){a.source.handshakeComplete=!0;a.source.setInstanceId(a.packingSlip.instanceId);a.source.pings[a.packingSlip.pingData.ticket]&&
(a.source.pings[a.packingSlip.pingData.ticket].callback({ticket:a.packingSlip.pingData.ticket,instanceId:a.packingSlip.instanceId,source:a.source}),a.source.pings[a.packingSlip.pingData.ticket]=void 0);n["default"].includes(k.state._clients,a.packingSlip.instanceId)||k.state._clients.push(a.packingSlip.instanceId);g["default"].publish({channel:"postal.federation",topic:"client.federated",data:{remoteId:a.source.instanceId,localId:g["default"].instanceId(),transport:a.transport}})},"federation.disconnect":function(a){k.state._clients=
n["default"].without(k.state._clients,a.source.instanceId);(0,k.disconnect)({transport:a.source.transportName,instanceId:a.source.instanceId,doNotNotify:!0})},"federation.message":function(a){var h=a.packingSlip.envelope;(0,l.matchesFilter)(h.channel,h.topic,"in")&&(h.lastSender=a.packingSlip.instanceId,g["default"].publish(h))},"federation.bundle":function(a){n["default"].forEach(a.packingSlip.packingSlips,function(h){b(n["default"].extend({},a,{packingSlip:h}))})}};e.handlers=m},function(d,e,a){Object.defineProperty(e,
"__esModule",{value:!0});e.addFilter=function(a){a=b["default"].isArray(a)?a:[a];b["default"].forEach(a,function(a){a.direction=a.direction||c.state._config.filterDirection;b["default"].forEach("both"===a.direction?["in","out"]:[a.direction],function(c){l[c][a.channel]?b["default"].includes(l[c][a.channel],a.topic)||l[c][a.channel].push(a.topic):l[c][a.channel]=[a.topic]})})};e.removeFilter=function(a){a=b["default"].isArray(a)?a:[a];b["default"].forEach(a,function(a){a.direction=a.direction||c.state._config.filterDirection;
b["default"].forEach("both"===a.direction?["in","out"]:[a.direction],function(c){l[c][a.channel]&&b["default"].includes(l[c][a.channel],a.topic)&&(l[c][a.channel]=b["default"].without(l[c][a.channel],a.topic))})})};e.matchesFilter=function(a,e,d){var f=Object.prototype.hasOwnProperty.call(l[d],a);a=f&&b["default"].some(l[d][a],function(a){return k["default"].configuration.resolver.compare(a,e)});d="blacklist"===c.state._config.filterMode;return c.state._config.enabled&&(d&&(!f||f&&!a)||!d&&f&&a)};
var b=(d=a(1))&&d.__esModule?d:{"default":d},c=a(5),k=(a=a(2))&&a.__esModule?a:{"default":a},l={"in":{},out:{}};e["default"]=l},function(d,e,a){Object.defineProperty(e,"__esModule",{value:!0});var b=function(){function a(a,c){for(var h=0;h<c.length;h++){var b=c[h];b.enumerable=b.enumerable||!1;b.configurable=!0;"value"in b&&(b.writable=!0);Object.defineProperty(a,b.key,b)}}return function(h,c,b){c&&a(h.prototype,c);b&&a(h,b);return h}}(),c=a(4),k=a(6),l=a(5),g=a(2),n=g&&g.__esModule?g:{"default":g},
m=(a=a(1))&&a.__esModule?a:{"default":a};a=function(){function a(c,b,d){if(!(this instanceof a))throw new TypeError("Cannot call a class as a function");this.target=c;this.options=b||{};this.pings={};this.instanceId=d;this.handshakeComplete=!1}b(a,[{key:"sendPing",value:function(a){var b=(0,c.getPackingSlip)("ping");this.pings[b.ticket]={ticket:b.ticket,callback:a||l.NO_OP};this.send(b)}},{key:"sendPong",value:function(a){this.send((0,c.getPackingSlip)("pong",a))}},{key:"sendBundle",value:function(a){this.send((0,
c.getPackingSlip)("bundle",a))}},{key:"sendMessage",value:function(a){this.handshakeComplete&&(a.originId=a.originId||n["default"].instanceId(),a=m["default"].clone(a),!this.instanceId||this.instanceId===a.lastSender||a.knownIds&&a.knownIds.length&&(!a.knownIds||m["default"].includes(a.knownIds,this.instanceId))||(a.knownIds=(a.knownIds||[]).concat(m["default"].without(l.state._clients,this.instanceId)),this.send((0,c.getPackingSlip)("message",a))))}},{key:"disconnect",value:function(){this.send((0,
c.getPackingSlip)("disconnect"))}},{key:"onMessage",value:function(a){this.shouldProcess()&&(0,k.onFederatedMsg)({transport:this.transportName,packingSlip:a,source:this})}},{key:"shouldProcess",value:function(){return!0}},{key:"send",value:function(){throw Error("An object deriving from FederationClient must provide an implementation for 'send'.");}},{key:"setInstanceId",value:function(a){this.instanceId=a}}],[{key:"extend",value:function(b,c){function d(){a.apply(this,arguments)}d.prototype=Object.create(a.prototype);
m["default"].extend(d.prototype,b);m["default"].extend(d,c);return d}}]);return a}();e["default"]=a;d.exports=e["default"]}])});