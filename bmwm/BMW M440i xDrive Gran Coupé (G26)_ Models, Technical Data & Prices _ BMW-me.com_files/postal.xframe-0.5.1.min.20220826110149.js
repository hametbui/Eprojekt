/*
 * postal.xframe - postal.js/postal.federation plugin for federating instances of postal.js across iframe/window boundaries.
  * Author: Jim Cowart (http://ifandelse.com)
  * Version: v0.5.1
  * Url: http://github.com/postaljs/postal.xframe
  * License(s): (MIT OR GPL-2.0)
*/
(function(n,m){"object"===typeof exports&&"object"===typeof module?module.exports=m(require("lodash"),require("postal"),require("postal.federation")):"function"===typeof define&&define.amd?define("postal.xframe",["lodash","postal","postal.federation"],m):"object"===typeof exports?exports.postalXframe=m(require("lodash"),require("postal"),require("postal.federation")):n.postalXframe=m(n._,n.postal,n["postal.federation"])})(this,function(n,m){return function(h){function d(k){if(a[k])return a[k].exports;
var l=a[k]={exports:{},id:k,loaded:!1};h[k].call(l.exports,l,l.exports,d);l.loaded=!0;return l.exports}var a={};d.m=h;d.c=a;d.p="";return d(0)}([function(h,d,a){function k(){e.routeMessage.apply(e,arguments)}function l(b){f.include(g.workers,b)||(b.addEventListener("message",k),g.workers.push(b))}h=function(b){return b&&b.__esModule?b["default"]:b};var f=h(a(1));d=h(a(2));var p=a(3),w=p._memoRemoteByInstanceId,v=p._memoRemoteByTarget,t=p._disconnectClient,u=p.safeSerialize;p=a(4);var g=p.state,c=
p.env,q=h(a(5));q.getInstance=function(b,g,c){b=new q(b,{origin:g,isWorker:"undefined"!==typeof Worker&&b instanceof Worker},c);b.options.isWorker&&l(b.target);return b};var r=function(){},e=d.fedx.transports.xframe={eagerSerialize:c.useEagerSerialize,XFrameClient:q,configure:function(b){b&&(g.config=f.defaults(f.extend(g.config,b),g.defaults));return g.config},clearConfiguration:function(){g.config=f.extend({},g.defaults)},getTargets:c.isWorker?function(){return[{target:{postMessage:postMessage}}]}:
function(){var b=f.map(document.getElementsByTagName("iframe"),function(b){var c=document.createElement("a");c.href=b.src;c=c.protocol+"//"+c.host;"//"===c&&(c=null);return{target:b.contentWindow,origin:c||g.config.defaultOriginUrl}});window.parent&&window.parent!==window&&b.push({target:window.parent,origin:"*"});return b.concat(g.workers)},remotes:[],wrapForTransport:c.useEagerSerialize?function(b){return JSON.stringify({postal:!0,packingSlip:b})}:function(b){return{postal:!0,packingSlip:b}},unwrapFromTransport:function(b){if("string"!==
typeof b||!c.useEagerSerialize&&-1===b.indexOf('"postal":true'))return b;try{return JSON.parse(b)}catch(y){return{}}},routeMessage:function(b){var c=b.source||b.currentTarget,g=this.unwrapFromTransport(b.data);if(g.postal){var e=f.find(this.remotes,function(b){return b.target===c});e||(e=q.getInstance(c,b.origin,g.packingSlip.instanceId),this.remotes.push(e));e.onMessage(g.packingSlip)}},sendMessage:function(b){var c=b;g.config.safeSerialize&&(c=u(f.cloneDeep(b)));f.forEach(this.remotes,function(b){b.sendMessage(c)})},
disconnect:function(b){b=b||{};var c=b.instanceId?f.reduce(f.isArray(b.instanceId)?b.instanceId:[b.instanceId],f.bind(w,this),[]):b.target?f.reduce(f.isArray(b.target)?b.target:[b.target],f.bind(v,this),[]):this.remotes;b.doNotNotify||f.forEach(c,f.bind(t,this));this.remotes=f.without.apply(null,[this.remotes].concat(c))},signalReady:function(b,c){b=f.isArray(b)?b:[b];b=b.length?b:this.getTargets();c=c||r;f.forEach(b,f.bind(function(b){if(b.target){b.origin=b.origin||g.config.defaultOriginUrl;var e=
f.find(this.remotes,function(c){return c.target===b.target});e||(e=q.getInstance(b.target,b.origin),this.remotes.push(e));e.sendPing(c)}},this))},addEventListener:c.isWorker?function(){addEventListener("message",k)}:function(b,c,e){if("undefined"!==typeof window&&"function"===typeof window.addEventListener)window.addEventListener(b,c,e);else throw Error("postal.xframe only works with browsers that support window.addEventListener");},listenToWorker:l,stopListeningToWorker:function(b){if(b)b.removeEventListener("message",
k),g.workers=f.without(g.workers,b);else for(;g.workers.length;)g.workers.pop().removeEventListener("message",k)}};e.addEventListener("message",k,!1)},function(h,d){h.exports=n},function(h,d){h.exports=m},function(h,d,a){function k(a){var d=!0,h=!1,p=void 0;try{for(var u=f(a)[Symbol.iterator](),g;!(d=(g=u.next()).done);d=!0){var c=void 0,q=g.value;if(Array.isArray(q))var r=q;else if(Symbol.iterator in Object(q)){for(var e=[],b=q[Symbol.iterator]();!(c=b.next()).done&&(e.push(c.value),2!==e.length););
r=e}else throw new TypeError("Invalid attempt to destructure non-iterable instance");var n=r[0],m=r[1];"function"===typeof m&&delete a[n];l.isPlainObject(m)&&k(m);l.isArray(m)&&l.forEach(m,k)}}catch(x){h=!0,p=x}finally{try{if(!d&&u["return"])u["return"]()}finally{if(h)throw p;}}return a}d._memoRemoteByInstanceId=function(a,d){var f=l.find(this.remotes,function(a){return a.instanceId===d});f&&a.push(f);return a};d._memoRemoteByTarget=function(a,d){var f=l.find(this.remotes,function(a){return a.target===
d});f&&a.push(f);return a};d._disconnectClient=function(a){a.disconnect()};d.safeSerialize=k;Object.defineProperty(d,"__esModule",{value:!0});var l=function(a){return a&&a.__esModule?a["default"]:a}(a(1)),f=regeneratorRuntime.mark(function v(a){var d,f,g,c,q,h;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:-1===["object","function"].indexOf(typeof a)&&(a={}),d=!0,f=!1,g=void 0,e.prev=4,c=Object.keys(a)[Symbol.iterator]();case 6:if(d=(q=c.next()).done){e.next=13;break}h=
q.value;e.next=10;return[h,a[h]];case 10:d=!0;e.next=6;break;case 13:e.next=19;break;case 15:e.prev=15,e.t0=e["catch"](4),f=!0,g=e.t0;case 19:if(e.prev=19,e.prev=20,!d&&c["return"])c["return"]();case 22:e.prev=22;if(!f){e.next=25;break}throw g;case 25:return e.finish(22);case 26:return e.finish(19);case 27:case "end":return e.stop()}},v,this,[[4,15,19,27],[20,,22,26]])});d.entries=f},function(h,d,a){Object.defineProperty(d,"__esModule",{value:!0});h=(h=a(1))&&h.__esModule?h["default"]:h;a={origin:location.origin||
location.protocol+"//"+location.host,isWorker:"undefined"===typeof window&&postMessage&&location,useEagerSerialize:/MSIE [8,9]/.test(navigator.userAgent)};d.env=a;a={allowedOrigins:[a.origin],enabled:!0,defaultOriginUrl:"*",safeSerialize:!1};h={workers:[],config:h.extend({},a),defaults:a};d.state=h},function(h,d,a){d=function(a){return a&&a.__esModule?a["default"]:a};var k=function(){function a(a,c){for(var g in c){var d=c[g];d.configurable=!0;d.value&&(d.writable=!0)}Object.defineProperties(a,c)}
return function(g,c,d){c&&a(g.prototype,c);d&&a(g,d);return g}}(),l=function r(a,c,d){var e=Object.getOwnPropertyDescriptor(a,c);if(void 0===e){if(a=Object.getPrototypeOf(a),null!==a)return r(a,c,d)}else{if("value"in e&&e.writable)return e.value;c=e.get;return void 0===c?void 0:c.call(d)}},f=function(a,c){if("function"!==typeof c&&null!==c)throw new TypeError("Super expression must either be null or a function, not "+typeof c);a.prototype=Object.create(c&&c.prototype,{constructor:{value:a,enumerable:!1,
writable:!0,configurable:!0}});c&&(a.__proto__=c)},p=d(a(2)),m=d(a(1));a=a(4);var n=a.state,t=a.env;a=function(a){function c(){for(var a=arguments.length,d=Array(a),e=0;e<a;e++)d[e]=arguments[e];if(!(this instanceof c))throw new TypeError("Cannot call a class as a function");this.transportName="xframe";l(Object.getPrototypeOf(c.prototype),"constructor",this).apply(this,d)}f(c,a);k(c,{shouldProcess:{value:function(){var a=!!n.config.allowedOrigins.length;return n.config.enabled&&("*"===this.options.origin||
a&&m.includes(n.config.allowedOrigins,this.options.origin)||!a||this.options.isWorker&&m.includes(n.workers,this.target)||t.isWorker)}},send:{value:function(a){if(this.shouldProcess()){var c=t.isWorker?null:this.target;a=[p.fedx.transports.xframe.wrapForTransport(a)];this.options.isWorker||t.isWorker||a.push(this.options.origin);t.isWorker?this.target.postMessage.apply(c,a):1===a.length?this.target.postMessage(a[0]):this.target.postMessage(a[0],a[1])}}}});return c}(p.fedx.FederationClient);h.exports=
a}])});